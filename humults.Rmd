---
title: "Humults Demo"
author: "Andrew G. Brown"
date: "10/29/2020"
output: html_document
---
  
```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.retina = 3, warning = FALSE, message = FALSE)
```

```{r}
library(aqp)
library(soilDB)
library(ggplot2)
library(magrittr)

# get 18 and 22A MLRA overlap KSSL pedon data
kssl <- fetchKSSL(mlra = c("18","22A"),
                  returnMorphologicData = TRUE,
                  returnGeochemicalData = TRUE,
                  simplifyColors = TRUE)

# identify soils with argillic horizon
argi <- profileApply(kssl$SPC, function(p) data.frame(id=profile_id(p), t(getArgillicBounds(p))), 
                     frameify = TRUE, column.names = c("pedon_key", "argi_top","argi_bot"))

argisub <- subset(kssl$SPC, profile_id(kssl$SPC) %in% argi$pedon_key[complete.cases(argi)])

# filter for valid geometry
argisub <- subset(argisub, !checkHzDepthLogic(argisub)$overlapOrGap)
hzidname(argisub) <- "labsampnum"

length(argisub)

# truncate to [0,100]
argisub <- trunc(argisub, 0, 100)

## OC
## 
dataslab <- slab(argisub, ~ oc + clay + db_od)
ocslab <- subset(dataslab, variable == "oc")
depths(ocslab) <- all.profiles ~ top + bottom
hzdesgnname(ocslab) <- "hzID"

## CLAY
## 
clayslab <- subset(dataslab, variable == "clay")
depths(clayslab) <- all.profiles ~ top + bottom
hzdesgnname(clayslab) <- "hzID"

## Db slab
## 
dbslab <- subset(dataslab, variable == "db_od")
depths(dbslab) <- all.profiles ~ top + bottom
hzdesgnname(dbslab) <- "hzID"

# using default mpspline2 lambda 
clayspline <- spc2mpspline(clayslab, "p.q50", lam = 0.1)
ocspline <- spc2mpspline(ocslab, "p.q50", lam = 0.1)
dbspline <- spc2mpspline(dbslab, "p.q50", lam = 0.1)
```

```{r, echo=FALSE}
ggplot(horizons(ocspline)) + 
  scale_y_reverse() +
  labs(title = "Spline + 1cm Slab Median Organic Carbon Content\nMLRA 18 & 22A Soils with Argillic Horizons",
       x = "Organic Carbon [% by mass]", y = "Depth [cm]") +
  geom_path(aes(x = p.q50_spline, y = top), linetype = 1, lwd = 1.5) +
  geom_path(aes(x = p.q50, y = top), linetype = 3) +
  theme_bw() 

ggplot(horizons(clayspline)) + 
  scale_y_reverse() +
  labs(title = "Spline + 1cm Slab Median Total Clay Content\nMLRA 18 & 22A Soils with Argillic Horizons",
       x = "Total Clay Content [%]", y = "Depth [cm]") +
  geom_path(aes(x = p.q50_spline, y = top), linetype = 1, lwd = 1.5) +
  geom_path(aes(x = p.q50, y = top), linetype = 3) + 
  theme_bw() 

ggplot(horizons(dbspline)) + 
  scale_y_reverse() +
  labs(title = "Spline + 1cm Slab Median Field-capacity Bulk Density\nMLRA 18 & 22A Soils with Argillic Horizons",
       x = "Bulk Density, 0.33 kPa, [g/cc]", y = "Depth [cm]") +
  geom_path(aes(x = p.q50_spline, y = top), linetype = 1, lwd = 1.5) +
  geom_path(aes(x = p.q50, y = top), linetype = 3) +
  theme_bw() + expand_limits(x = c(1.15, 1.4))
```

```{r}
ocspline$spline_q50_db13 <- dbspline$p.q50_spline
ocspline$spline_q50_clay <- clayspline$p.q50_spline

# calculate organic carbon in kg/m^2 
#  carbon content multipled by bulk density in kg/m^3 multiplied by layer thickness in meters
medianstock <- sum(ocspline$p.q50_spline / 100 * ocspline$spline_q50_db13 * 1000) / 100

# convert to Mg/m^3 for taxonomic eval (> or < 12)
medianstock # in general, soils with argillic horizons in 18+22A are not Humults

# 152 profiles have zero missing carbon within the estimated soil depth
table(floor(evalMissingData(argisub, "oc", name = "hzn_desgn")))

# in contrast, only 29 profiles have bulk density 0.33 kPa across same depth
table(floor(evalMissingData(argisub, "db_13b", name = "hzn_desgn")))

# keep the ones with full carbon data in 0-100cm interval
argisub <- subset(argisub, as.logical(floor(evalMissingData(trunc(argisub, 0, 100), "oc", name = "hzn_desgn"))))
```

# Simple gap filling in bulk density

```{r}
argisub$db_13b[grepl("O", argisub$hzn_desgn) & is.na(argisub$db_13b)] <- 0.3
argisub$db_13b[grepl("A", argisub$hzn_desgn) & is.na(argisub$db_13b)] <- 1.2
argisub$db_13b[grepl("B", argisub$hzn_desgn) & is.na(argisub$db_13b)] <- 1.3
argisub$db_13b[grepl("C", argisub$hzn_desgn) & is.na(argisub$db_13b)] <- 1.35
```

### Calculate organic carbon in kg/m^2. 

Carbon content multipled by bulk density in kg/m^3 multiplied by layer thickness in meters

```{r}
res <- argisub %>%
  trunc(0, 100) %>%
  mutate_profile(thk = (hzn_bot - hzn_top),
                 c_stock_partial = (oc / 100) * ((db_13b * 1e6) / 1000) * (thk / 100),
                 cml_stock = cumsum(ifelse(is.na(c_stock_partial), 0, c_stock_partial)),
                 c_stock = sum(c_stock_partial, na.rm = TRUE))
```

```{r, echo = FALSE}
plot(density(res$c_stock, from = 0))
abline(v=12, lwd=2, col="blue")
quantile(res$c_stock, probs = c(0, 0.5, 0.75, 0.95, 0.99, 1), na.rm = TRUE)
```

### Visualizations of cumulative carbon stocks

```{r}
res$cml_stock_gt12 <- factor(res$cml_stock > 12)
humcrit <- subset(res, c_stock > 12)
plot(humcrit, color = "oc", name = NA, width = 0.5, print.id=FALSE)
plot(humcrit, color = "c_stock_partial", name = NA, width = 0.5, print.id=FALSE)
plot(humcrit, color = "cml_stock_gt12", name = NA, width = 0.5, print.id=FALSE)

# these meet it in first horizon, and have thick A horizons.
humfhz <- subset(humcrit, humcrit[,1]$cml_stock_gt12 != FALSE)
plot(humfhz, color = "c_stock_partial")
table(humfhz$taxsuborder)
```

### Spatial relationships of higher carbon accumulation

The carbon criterion for Humults is most commonly met in mesic temperature regimes. 

...

```{r}
round(prop.table(table(humcrit$taxtempcl, useNA = "ifany")),3)
```

The _thermic_ temperature classes dominate profiles where carbon stocks are less than $12 kg/m^2$, with a sizable mesic and unassigned portion.

```{r}
humnocrit <- subset(res, c_stock < 12)
round(prop.table(table(humnocrit$taxtempcl, useNA = "ifany")),3)
```
